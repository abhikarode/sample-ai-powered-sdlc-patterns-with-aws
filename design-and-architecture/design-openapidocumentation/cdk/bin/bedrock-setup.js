#!/usr/bin/env node
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const cdk = require("aws-cdk-lib");
const opensearch_stack_1 = require("../lib/stacks/opensearch-stack");
const bedrock_stack_1 = require("../lib/stacks/bedrock-stack");
const storage_stack_1 = require("../lib/stacks/storage-stack");
const lambda_stack_1 = require("../lib/stacks/lambda-stack");
const amplify_auth_stack_1 = require("../lib/stacks/amplify-auth-stack");
const app = new cdk.App();
// Deploy OpenSearch Stack first
const opensearchStack = new opensearch_stack_1.OpenSearchStack(app, 'OpenSearchStack', {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION || 'us-east-1'
    }
});
// Deploy Storage Stack second
const storageStack = new storage_stack_1.StorageStack(app, 'StorageStack', {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION || 'us-east-1'
    }
});
// Deploy Bedrock Stack third
const bedrockStack = new bedrock_stack_1.BedrockStack(app, 'BedrockStack', {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION || 'us-east-1'
    },
    collectionArn: opensearchStack.collection.attrArn,
    bucketArn: opensearchStack.s3Bucket.attrArn,
    bedrockRoleArn: opensearchStack.bedrockRole.attrArn
});
// Deploy Lambda Stack fourth (depends on Bedrock and Storage)
const lambdaStack = new lambda_stack_1.LambdaStack(app, 'LambdaStack', {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION || 'us-east-1'
    },
    domainAnalyzerBucket: storageStack.domainAnalyzerBucket,
    bedrockAgentId: bedrockStack.agentId,
    bedrockAgentAliasId: 'TSTALIASID', // Default test alias ID
    knowledgeBaseId: bedrockStack.knowledgeBaseId
});
// Deploy Amplify Auth Stack fifth (depends on Lambda functions)
const amplifyAuthStack = new amplify_auth_stack_1.AmplifyAuthStack(app, 'AmplifyAuthStack', {
    env: {
        account: process.env.CDK_DEFAULT_ACCOUNT,
        region: process.env.CDK_DEFAULT_REGION || 'us-east-1'
    },
    domainAnalyzerFunction: lambdaStack.domainAnalyzerFunction,
    docGeneratorFunction: lambdaStack.docGeneratorFunction,
    backendFunction: lambdaStack.backendFunction,
    backendFunctionUrl: lambdaStack.backendFunctionUrl,
    apiGatewayUrl: '' // No API Gateway needed - using Lambda Function URL
});
// Add dependencies to ensure proper deployment order
storageStack.addDependency(opensearchStack);
bedrockStack.addDependency(storageStack);
lambdaStack.addDependency(bedrockStack);
amplifyAuthStack.addDependency(lambdaStack);
app.synth();
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYmVkcm9jay1zZXR1cC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImJlZHJvY2stc2V0dXAudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBQ0EsbUNBQW1DO0FBQ25DLHFFQUFpRTtBQUNqRSwrREFBMkQ7QUFDM0QsK0RBQTJEO0FBQzNELDZEQUF5RDtBQUN6RCx5RUFBb0U7QUFHcEUsTUFBTSxHQUFHLEdBQUcsSUFBSSxHQUFHLENBQUMsR0FBRyxFQUFFLENBQUM7QUFFMUIsZ0NBQWdDO0FBQ2hDLE1BQU0sZUFBZSxHQUFHLElBQUksa0NBQWUsQ0FBQyxHQUFHLEVBQUUsaUJBQWlCLEVBQUU7SUFDbEUsR0FBRyxFQUFFO1FBQ0gsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO1FBQ3hDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLFdBQVc7S0FDdEQ7Q0FDRixDQUFDLENBQUM7QUFFSCw4QkFBOEI7QUFDOUIsTUFBTSxZQUFZLEdBQUcsSUFBSSw0QkFBWSxDQUFDLEdBQUcsRUFBRSxjQUFjLEVBQUU7SUFDekQsR0FBRyxFQUFFO1FBQ0gsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO1FBQ3hDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLFdBQVc7S0FDdEQ7Q0FDRixDQUFDLENBQUM7QUFFSCw2QkFBNkI7QUFDN0IsTUFBTSxZQUFZLEdBQUcsSUFBSSw0QkFBWSxDQUFDLEdBQUcsRUFBRSxjQUFjLEVBQUU7SUFDekQsR0FBRyxFQUFFO1FBQ0gsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO1FBQ3hDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLFdBQVc7S0FDdEQ7SUFDRCxhQUFhLEVBQUUsZUFBZSxDQUFDLFVBQVUsQ0FBQyxPQUFPO0lBQ2pELFNBQVMsRUFBRSxlQUFlLENBQUMsUUFBUSxDQUFDLE9BQU87SUFDM0MsY0FBYyxFQUFFLGVBQWUsQ0FBQyxXQUFXLENBQUMsT0FBTztDQUNwRCxDQUFDLENBQUM7QUFFSCw4REFBOEQ7QUFDOUQsTUFBTSxXQUFXLEdBQUcsSUFBSSwwQkFBVyxDQUFDLEdBQUcsRUFBRSxhQUFhLEVBQUU7SUFDdEQsR0FBRyxFQUFFO1FBQ0gsT0FBTyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CO1FBQ3hDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLFdBQVc7S0FDdEQ7SUFDRCxvQkFBb0IsRUFBRSxZQUFZLENBQUMsb0JBQW9CO0lBQ3ZELGNBQWMsRUFBRSxZQUFZLENBQUMsT0FBTztJQUNwQyxtQkFBbUIsRUFBRSxZQUFZLEVBQUUsd0JBQXdCO0lBQzNELGVBQWUsRUFBRSxZQUFZLENBQUMsZUFBZTtDQUM5QyxDQUFDLENBQUM7QUFJSCxnRUFBZ0U7QUFDaEUsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLHFDQUFnQixDQUFDLEdBQUcsRUFBRSxrQkFBa0IsRUFBRTtJQUNyRSxHQUFHLEVBQUU7UUFDSCxPQUFPLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBbUI7UUFDeEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksV0FBVztLQUN0RDtJQUNELHNCQUFzQixFQUFFLFdBQVcsQ0FBQyxzQkFBc0I7SUFDMUQsb0JBQW9CLEVBQUUsV0FBVyxDQUFDLG9CQUFvQjtJQUN0RCxlQUFlLEVBQUUsV0FBVyxDQUFDLGVBQWU7SUFDNUMsa0JBQWtCLEVBQUUsV0FBVyxDQUFDLGtCQUFrQjtJQUNsRCxhQUFhLEVBQUUsRUFBRSxDQUFDLG9EQUFvRDtDQUN2RSxDQUFDLENBQUM7QUFFSCxxREFBcUQ7QUFDckQsWUFBWSxDQUFDLGFBQWEsQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUM1QyxZQUFZLENBQUMsYUFBYSxDQUFDLFlBQVksQ0FBQyxDQUFDO0FBQ3pDLFdBQVcsQ0FBQyxhQUFhLENBQUMsWUFBWSxDQUFDLENBQUM7QUFDeEMsZ0JBQWdCLENBQUMsYUFBYSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0FBRTVDLEdBQUcsQ0FBQyxLQUFLLEVBQUUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIiMhL3Vzci9iaW4vZW52IG5vZGVcbmltcG9ydCAqIGFzIGNkayBmcm9tICdhd3MtY2RrLWxpYic7XG5pbXBvcnQgeyBPcGVuU2VhcmNoU3RhY2sgfSBmcm9tICcuLi9saWIvc3RhY2tzL29wZW5zZWFyY2gtc3RhY2snO1xuaW1wb3J0IHsgQmVkcm9ja1N0YWNrIH0gZnJvbSAnLi4vbGliL3N0YWNrcy9iZWRyb2NrLXN0YWNrJztcbmltcG9ydCB7IFN0b3JhZ2VTdGFjayB9IGZyb20gJy4uL2xpYi9zdGFja3Mvc3RvcmFnZS1zdGFjayc7XG5pbXBvcnQgeyBMYW1iZGFTdGFjayB9IGZyb20gJy4uL2xpYi9zdGFja3MvbGFtYmRhLXN0YWNrJztcbmltcG9ydCB7IEFtcGxpZnlBdXRoU3RhY2sgfSBmcm9tICcuLi9saWIvc3RhY2tzL2FtcGxpZnktYXV0aC1zdGFjayc7XG5cblxuY29uc3QgYXBwID0gbmV3IGNkay5BcHAoKTtcblxuLy8gRGVwbG95IE9wZW5TZWFyY2ggU3RhY2sgZmlyc3RcbmNvbnN0IG9wZW5zZWFyY2hTdGFjayA9IG5ldyBPcGVuU2VhcmNoU3RhY2soYXBwLCAnT3BlblNlYXJjaFN0YWNrJywge1xuICBlbnY6IHtcbiAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OIHx8ICd1cy1lYXN0LTEnXG4gIH1cbn0pO1xuXG4vLyBEZXBsb3kgU3RvcmFnZSBTdGFjayBzZWNvbmRcbmNvbnN0IHN0b3JhZ2VTdGFjayA9IG5ldyBTdG9yYWdlU3RhY2soYXBwLCAnU3RvcmFnZVN0YWNrJywge1xuICBlbnY6IHtcbiAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OIHx8ICd1cy1lYXN0LTEnXG4gIH1cbn0pO1xuXG4vLyBEZXBsb3kgQmVkcm9jayBTdGFjayB0aGlyZFxuY29uc3QgYmVkcm9ja1N0YWNrID0gbmV3IEJlZHJvY2tTdGFjayhhcHAsICdCZWRyb2NrU3RhY2snLCB7XG4gIGVudjoge1xuICAgIGFjY291bnQ6IHByb2Nlc3MuZW52LkNES19ERUZBVUxUX0FDQ09VTlQsXG4gICAgcmVnaW9uOiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9SRUdJT04gfHwgJ3VzLWVhc3QtMSdcbiAgfSxcbiAgY29sbGVjdGlvbkFybjogb3BlbnNlYXJjaFN0YWNrLmNvbGxlY3Rpb24uYXR0ckFybixcbiAgYnVja2V0QXJuOiBvcGVuc2VhcmNoU3RhY2suczNCdWNrZXQuYXR0ckFybixcbiAgYmVkcm9ja1JvbGVBcm46IG9wZW5zZWFyY2hTdGFjay5iZWRyb2NrUm9sZS5hdHRyQXJuXG59KTtcblxuLy8gRGVwbG95IExhbWJkYSBTdGFjayBmb3VydGggKGRlcGVuZHMgb24gQmVkcm9jayBhbmQgU3RvcmFnZSlcbmNvbnN0IGxhbWJkYVN0YWNrID0gbmV3IExhbWJkYVN0YWNrKGFwcCwgJ0xhbWJkYVN0YWNrJywge1xuICBlbnY6IHtcbiAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OIHx8ICd1cy1lYXN0LTEnXG4gIH0sXG4gIGRvbWFpbkFuYWx5emVyQnVja2V0OiBzdG9yYWdlU3RhY2suZG9tYWluQW5hbHl6ZXJCdWNrZXQsXG4gIGJlZHJvY2tBZ2VudElkOiBiZWRyb2NrU3RhY2suYWdlbnRJZCxcbiAgYmVkcm9ja0FnZW50QWxpYXNJZDogJ1RTVEFMSUFTSUQnLCAvLyBEZWZhdWx0IHRlc3QgYWxpYXMgSURcbiAga25vd2xlZGdlQmFzZUlkOiBiZWRyb2NrU3RhY2sua25vd2xlZGdlQmFzZUlkXG59KTtcblxuXG5cbi8vIERlcGxveSBBbXBsaWZ5IEF1dGggU3RhY2sgZmlmdGggKGRlcGVuZHMgb24gTGFtYmRhIGZ1bmN0aW9ucylcbmNvbnN0IGFtcGxpZnlBdXRoU3RhY2sgPSBuZXcgQW1wbGlmeUF1dGhTdGFjayhhcHAsICdBbXBsaWZ5QXV0aFN0YWNrJywge1xuICBlbnY6IHtcbiAgICBhY2NvdW50OiBwcm9jZXNzLmVudi5DREtfREVGQVVMVF9BQ0NPVU5ULFxuICAgIHJlZ2lvbjogcHJvY2Vzcy5lbnYuQ0RLX0RFRkFVTFRfUkVHSU9OIHx8ICd1cy1lYXN0LTEnXG4gIH0sXG4gIGRvbWFpbkFuYWx5emVyRnVuY3Rpb246IGxhbWJkYVN0YWNrLmRvbWFpbkFuYWx5emVyRnVuY3Rpb24sXG4gIGRvY0dlbmVyYXRvckZ1bmN0aW9uOiBsYW1iZGFTdGFjay5kb2NHZW5lcmF0b3JGdW5jdGlvbixcbiAgYmFja2VuZEZ1bmN0aW9uOiBsYW1iZGFTdGFjay5iYWNrZW5kRnVuY3Rpb24sXG4gIGJhY2tlbmRGdW5jdGlvblVybDogbGFtYmRhU3RhY2suYmFja2VuZEZ1bmN0aW9uVXJsLFxuICBhcGlHYXRld2F5VXJsOiAnJyAvLyBObyBBUEkgR2F0ZXdheSBuZWVkZWQgLSB1c2luZyBMYW1iZGEgRnVuY3Rpb24gVVJMXG59KTtcblxuLy8gQWRkIGRlcGVuZGVuY2llcyB0byBlbnN1cmUgcHJvcGVyIGRlcGxveW1lbnQgb3JkZXJcbnN0b3JhZ2VTdGFjay5hZGREZXBlbmRlbmN5KG9wZW5zZWFyY2hTdGFjayk7XG5iZWRyb2NrU3RhY2suYWRkRGVwZW5kZW5jeShzdG9yYWdlU3RhY2spO1xubGFtYmRhU3RhY2suYWRkRGVwZW5kZW5jeShiZWRyb2NrU3RhY2spO1xuYW1wbGlmeUF1dGhTdGFjay5hZGREZXBlbmRlbmN5KGxhbWJkYVN0YWNrKTtcblxuYXBwLnN5bnRoKCk7XG4iXX0=